<br><br>
<div class="container">
    <div class="container">
        <div class="pageWrapper">
            <!--Body Content-->
            <div id="page-content">
                <!--Page Title-->
                <div class="page section-header text-center">
                    <div class="page-title">
                        <div class="wrapper"></div>
                    </div>
                </div>
                <!--End Page Title-->
                <div class="container">
                    <div class="container">
                        <div class="row billing-fields">
                            <div class="col-xl-6 col-lg-6 col-md-6 col-sm-12 sm-margin-30px-bottom">
                                <div class="create-ac-content bg-light-gray padding-20px-all">
                                    <br><br>
                                    <h2>Deliver to:</h2>
                                    <br>
                                    <div class="row">
                                        <select class="form-select form-select-lg mb-3" id="addressform"
                                            onchange="addressValue()">
                                            {{#each userAddress}}
                                            <option {{_id}}>
                                                <div class="col-md-6">
                                                    <div
                                                        class="bg-white card addresses-item mb-4 border border-primary shadow">
                                                        <div class="gold-members p-4">
                                                            <div class="media">
                                                                <div class="mr-3"><i
                                                                        class="icofont-ui-home icofont-3x"></i>
                                                                </div>
                                                                <div class="media-body">
                                                                    <h6>{{deliver_to}}</h6>&nbsp
                                                                    <p>{{name}} &nbsp
                                                                        &nbsp<b>{{number}}</b>
                                                                    </p>
                                                                    <p>{{house}}</p>
                                                                    <p>{{city}}, {{state}}, {{country}}</p>
                                                                    <p>{{address}} - {{pincode}} </p>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </option>
                                            {{/each}}
                                        </select>

                                        <input type="hidden" id="addressform" name="selectedAddress">
                                        <br>
                                        <div class="d-flex justify-content-left mb-2">
                                            <button class="btn btn-dark  btn-sm mb-2  " onclick="addNewAddress()" <i
                                                class="ci-close-circle me-2"></i><span class="fs-sm">Add New
                                                    Address</span>Â </button>
                                        </div>
                                    </div>
                                    <div class="card mb-4">
                                        <div class="card-header py-3">
                                            <h6 class="mb-0">Apply Promo Code</h6>
                                        </div>
                                        <div class="card-body">

                                            <ul class="list-group list-group-flush">

                                                <li
                                                    class="list-group-item d-flex justify-content-between align-items-center border-0 px-0 pb-0">

                                                    <input type="text" id="couponCode" name="coupon"
                                                        placeholder="Enter Coupon code">
                                                    <br>
                                                </li>
                                                <br>
                                            </ul>
                                            <button class="btn btn-dark btn-block " onclick="checkCoupon()">
                                                Apply Code
                                            </button>
                                            <span id="errorMessage"></span>

                                        </div>
                                    </div>
                                </div>
                            </div>


                            <div class="col-xl-6 col-lg-6 col-md-6 col-sm-12">
                                <div class="your-order-payment">
                                    <div class="your-order">
                                        <h2 class="order-title mb-4">Your Order</h2>

                                        <div class="table-responsive-sm order-table table-bordered">
                                            <table class="table">
                                                <thead>
                                                    <tr>
                                                        <th scope="col">Product Name</th>
                                                        <th scope="col">Quantiy</th>
                                                        <th scope="col">Price</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    {{#each productDetails}}
                                                    <tr>
                                                        <td scope="row">{{this.Name}}</td>
                                                        <td>{{this.quantity}}</td>
                                                        <td>{{this.Price}}</td>
                                                        <input type="hidden" name="productid" value="{{this._id}}">
                                                        <input type="hidden" name="productname" value="{{this.Name}}">
                                                        <input type="hidden" name="price" value="{{this.Price}}">
                                                        <input type="hidden" name="quantity" value="{{this.quantity}}">
                                                    </tr>
                                                    {{/each}}
                                                </tbody>
                                                <tfoot>
                                                    <tr>
                                                        <td>Total</td>
                                                        <td></td>
                                                        <td>{{subtotal}}</td>
                                                        <input type="hidden" name="subtotal" id="subtotal"
                                                            value="{{subtotal}}">
                                                    </tr>
                                                </tfoot>
                                            </table>
                                        </div>
                                    </div>
                                    <li class="list-group-item d-flex justify-content-between align-items-center px-0">
                                        Offer
                                        <h3 id="offer" class="fw-normal">{{offer}} %</h3>
                                    </li>

                                    <li
                                        class="list-group-item d-flex justify-content-between align-items-center border-0 px-0 mb-3">
                                        <div>
                                            <strong>Total amount</strong>

                                        </div>
                                        <h3 id="gtotal" class="fw-normal">{{gtotal}}</h3>

                                    </li>
                                    {{!-- <div class="card mb-4">
                                        <div class="card-header py-3">
                                            <h5 class="mb-0">Apply Promo Code</h5>
                                        </div> --}}
                                        {{!-- <div class="card-body">

                                            <ul class="list-group list-group-flush">

                                                <li
                                                    class="list-group-item d-flex justify-content-between align-items-center border-0 px-0 pb-0">
                                                    Code
                                                    <input type="text" id="couponCode" name="coupon">
                                                    <br>
                                                </li>
                                                <br>
                                            </ul>
                                            <button class="btn btn-dark btn-lg btn-block " onclick="checkCoupon()">
                                                Apply Code
                                            </button>
                                            <span id="errorMessage"></span>

                                        </div> --}}
                                        {{!--
                                    </div> --}}

                                    <hr>
                                    <div class="container">
                                        <div class="your-payment">
                                            <h4 class="payment-title mb-3">Payment Method</h4>
                                            <br>
                                            <div class="payment-method">
                                                <div class="form-check">
                                                    <input onclick="enableButton()" class="form-check-input"
                                                        type="radio" name="payment" id="COD" value="1">
                                                    <label class="form-check-label" for="payment1">
                                                        Cash On Delivery
                                                    </label>
                                                    <div>
                                                        <input onclick="enableButton()" class="form-check-input"
                                                            type="radio" name="payment" id="rzp-button1" value="2">
                                                        <label class="form-check-label" for="payment2">
                                                            RazorPay
                                                        </label>
                                                    </div>
                                                </div>
                                                <hr>
                                                <div class="order-button-payment">
                                                    <button class="btn btn-dark" onclick="CheckplaceOrder()"
                                                        value="Place order" id="placeOrderButton" disabled>Place
                                                        order</button>
                                                </div>
                                                <input type="hidden" name="radioValue">
                                            </div>
                                        </div>
                                    </div>



                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal -->
<div class="modal fade" id="addAddressModal" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1"
    aria-labelledby="staticBackdropLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="staticBackdropLabel">Add New Address</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form class="row g-3" method="post">

                    <div class="row g-2">
                        <div class="col-6">
                            <br>
                            <label for="inputCity" class="form-label">Name</label>
                            <input type="text" class="form-control" id="modalName" name="name">

                        </div>

                        <div class="col-6">
                            <br>
                            <label for="inputCity" class="form-label">Mobile</label>
                            <input type="text" class="form-control" id="modalMobile" name="mobile">

                        </div>

                    </div>

                    <div class="row g-2">
                        <div class="col-6">
                            <label for="inputEmail4" class="form-label">House</label>
                            <input type="text" class="form-control" id="modalAddress" name="house">
                            <br>
                        </div>
                        <div class="col-6">
                            <label for="inputCity" class="form-label">City</label>
                            <input type="text" class="form-control" id="modalCity" name="city">
                            <br>
                            <div class="col-12">
                                <label for="inputCity" class="form-label">State</label>
                                <input type="text" class="form-control" id="modalState" name="state">
                            </div>
                            <br>
                            <div class="col-12">
                                <label for="inputCity" class="form-label">Pincode</label>
                                <input type="number" class="form-control" id="modalPin" name="pin">
                                <br>
                            </div>
                        </div>
                    </div>
            </div>
            <div class="row sign-btn2">
                <div class="col-sm-1 m-2">

                    <button type="button" class="btn btn-secondary" onclick="insertAddress()">Add</button>
                    <br><br>
                </div>
                <div class="col-sm-1 m-2">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>

            </div>

            </form>
        </div>

    </div>
</div>
</div>
</div>

</body>
<script src="https://checkout.razorpay.com/v1/checkout.js"></script>

<script>






    let GrandTotal;

    let payment;
    let subtotal;
    subtotal = Number(document.getElementById('subtotal').value)
    let gtotal = Number(document.getElementById('gtotal').innerHTML)

    gtotal = gtotal * 100;





    async function checkCoupon() {
        console.log("256 check >>")
        const coupon = document.getElementById('couponCode').value;
        const total = document.getElementById('subtotal').value
        console.log(total, "total")
        console.log(coupon)
        let valCoupon = await fetch('/validateCoupon', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ code: coupon, total: total }),
        });
        let response = await valCoupon.json()
        console.log(response, "res")

        if (response == "fail") {
            sessionStorage.setItem('couponInvalidMessage', 'Coupon Invalid');
            document.getElementById("errorMessage").innerHTML = "Coupon Invalid";

        }
        else {

            GrandTotal = Number(response.gtotal)
            console.log(GrandTotal, "gtotal gr")

            let offer = document.getElementById("offer").innerHTML = Number(response.offerPrice)

            console.log(Number(response.offerPrice))

            let subtotal = document.getElementById('subtotal').value

            let gtotal = document.getElementById('gtotal').innerHTML

            const amt = Number(subtotal) * Number(offer) / 100

            gtotal = gtotal - amt

            document.getElementById('gtotal').innerHTML = gtotal

        }
    }

    async function addNewAddress() {
        $('#addAddressModal').modal('show')
    }


    async function insertAddress() {
        const Name = document.getElementById('modalName').value
        const mobile = document.getElementById('modalMobile').value
        const address = document.getElementById('modalAddress').value
        const city = document.getElementById('modalCity').value
        const state = document.getElementById('modalState').value
        const pincode = document.getElementById('modalPin').value


        let addAddress = await fetch('/addAddresscheckout', {
            headers: {
                'Content-Type': 'application/json',
            },
            method: 'post',
            body: JSON.stringify({  Name: Name,
            mobile: mobile,
            house: address,
            city: city,
            state: state,
            pin: pincode,}),
        })

        let response = await addAddress.json()
        if (response == 'success') {
            $('#addAddressModal').modal('hide')
            Swal.fire({
                title: 'Success',
                text: "Address Added Successfully !",
                icon: 'success',
                confirmButtonColor: '#3085d6',
                cancelButtonColor: '#d33',
                confirmButtonText: 'OK',
                timer: 3000
            }).then((res) => {
                window.location.reload()
            })
        } else {
            Swal.fire({
                icon: 'error',
                title: 'Oops...',
                text: 'Something went wrong!',
            })
        }
    }

    window.onload = () => {
        const couponInvalidMessage = sessionStorage.getItem('couponInvalidMessage');
        if (couponInvalidMessage) {
            document.getElementById("errorMessage").innerHTML = "";
            sessionStorage.removeItem('couponInvalidMessage');
        }
    }

    async function enableButton() {

        document.getElementById('placeOrderButton').disabled = false
        console.log(subtotal)
    }

    const amount = document.getElementById("gtotal").innerHTML * 100
    console.log(amount, "amount line 229")

    async function CheckplaceOrder() {
        payment = Object.values(document.getElementsByName('payment')).filter((item) => item.checked ? item : '').map((item) => item.value)
        if (payment[0] === '1') {

            placeOrder();
        } else {

            let orderId;
            subtotal = gtotal
            $(document).ready(function () {

                let settings = {
                    url: "/create/orderId",
                    method: "POST",
                    timeout: 0,
                    headers: {
                        "Content-Type": "application/json",
                    },
                    data: JSON.stringify({
                        amount: document.getElementById('gtotal').innerHTML * 100, //CHANGE THE AMOUNT AS NEEDED
                    }),
                };

                //creates new orderId everytime
                $.ajax(settings).done(function (response) {
                    orderId = response.orderId;
                    console.log(orderId);
                });
            });



            document.getElementById("placeOrderButton").onclick = function (e) {
                let options = {
                    key: "rzp_test_HoTBsfjjQ8ECAO", // Enter the Key ID generated from the Dashboard
                    amount: document.getElementById('gtotal').innerHTML * 100, // Amount is in currency subunits. Default currency is INR. Hence, 50000 refers to 50000 paise
                    currency: "INR",
                    name: "Magic Book",
                    description: "Test Transaction",
                    image: "https://example.com/your_logo",
                    order_id: orderId, //This is a sample Order ID. Pass the `id` obtained in the response of Step 1
                    handler: function (response) {
                        let settings = {
                            url: "/api/payment/verify",
                            method: "POST",
                            timeout: 0,
                            headers: {
                                "Content-Type": "application/json",
                            },
                            data: JSON.stringify({ response }),
                        };
                        console.log(response)
                        $.ajax(settings).done(function (response) {
                            placeOrder();
                            alert(JSON.stringify(response));
                        });
                    },
                    theme: {
                        color: "#99cc33",
                    },
                };
                let rzp1 = new Razorpay(options);
                rzp1.on("payment.failed", function (response) {
                   
                    rzp1.close();
                   Swal.fire({
                title: 'Something went wrong',
                text: "something went wrong !",

                icon: 'failure',
                confirmButtonColor: '#3085d6',
                cancelButtonColor: '#d33',
                confirmButtonText: 'OK',
                timer: 3000
            }).then((res) => {
                window.location.href = '/home'
            })
                });
                rzp1.open();
                
                e.preventDefault();
            };
        }
    }


    async function placeOrder() {
        const productid = Object.values(document.getElementsByName('productid')).map((item) => item.value)
        const productname = Object.values(document.getElementsByName('productname')).map((item) => item.value)
        const price = Object.values(document.getElementsByName('price')).map((item) => item.value)
        const quantity = Object.values(document.getElementsByName('quantity')).map((item) => item.value)
        const addressId = document.getElementById('addressform').value
        const total = Object.values(document.getElementsByName('subtotal')).map((item) => item.value)
        const coupon = document.getElementById('couponCode').value;


        let data = {
            productid: productid,
            productname: productname,
            price: price,
            quantity: quantity,
            addressId: addressId,
            payment: payment,
            total: total,
            coupon: coupon

        }

        try {
            let orderplacement = await fetch('/place-order', {
                method: 'post',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(data)
            })
            let res = await orderplacement.json()
            console.log(res, "res in place")
            if (res == "success") {
                Swal.fire({
                    title: 'Success',
                    text: "Item ordered successfully !",
                    icon: 'success',
                    confirmButtonColor: '#3085d6',
                    cancelButtonColor: '#d33',
                    confirmButtonText: 'OK',
                    timer: 3000
                }).then((res) => {
                    window.location.href = '/home'
                })
            } else Swal.fire({
                title: 'Something went wrong',
                text: "Payment Failed",

                icon: 'failure',
                confirmButtonColor: '#3085d6',
                cancelButtonColor: '#d33',
                confirmButtonText: 'OK',
                timer: 3000
            }).then((res) => {
                window.location.href = '/home'
            })
        } catch (error) {
            console.log(error)
        }



    }



</script>


 {{!-- alert(response.error.code);
                    alert(response.error.description);
                    alert(response.error.source);
                    alert(response.error.step);
                    alert(response.error.reason);
                    alert(response.error.metadata.order_id);
                    alert(response.error.metadata.payment_id); --}}